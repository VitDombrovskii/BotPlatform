
# 11-storage-layer.md — Storage Layer в BotPlatform

## 1. Назначение Storage Layer

Storage Layer — это подсистема хранения данных платформы.  
Она отвечает за долговечность и восстановимость состояния:

- состояние позиций,
- история ордеров,
- события,
- снапшоты стратегий,
- конфигурации,
- пользовательские данные.

Без Storage Layer система не сможет восстанавливаться после рестартов и масштабироваться.

---

## 2. Типы данных, которые нужно хранить

### 2.1 Runtime состояние
- Positions (открытые позиции, средняя цена, объём)
- Active orders (ожидающие исполнения)
- Strategy state (внутреннее состояние стратегий)
- Leg state (контроллеры, пузырьки, scale-in/out)
- Cache сигналов

Это состояние необходимо для восстановления после падения.

### 2.2 История исполнения
- ордера,
- обновления ордеров,
- сделки,
- стратегия → действия → исполнение.

### 2.3 Журнальные события
- любые события EventBus,
- ошибки,
- предупреждения,
- системные статусы.

### 2.4 Конфигурации
- параметры стратегий,
- параметры движков,
- пользователи,
- API-ключи (в зашифрованном виде).

---

## 3. Архитектурные компоненты Storage Layer

```
StorageLayer
├── StateStore
├── EventStore
├── HistoryStore
├── ConfigStore
└── SnapshotEngine
```

### 3.1 StateStore
Хранит **текущее состояние**, необходимое для работы:

- позиции,
- состояние стратегий,
- активные ордера,
- состояние legs.

Тип хранения:  
Redis, SQLite, PostgreSQL, LMDB (для HFT).

### 3.2 EventStore
Хранит **все события EventBus**, которые подлежат логированию.

Поддержка:
- append-only лог,
- быстрый поиск,
- реплей событий (как в Kafka).

### 3.3 HistoryStore
Хранит торговую историю:

- сделанные сделки,
- все действия стратегий,
- все `order.*` события.

Это необходимо для аналитики.

### 3.4 ConfigStore
Хранит:
- конфиги стратегий,
- планировочные параметры,
- API-ключи (KMS/Hashicorp Vault).

### 3.5 SnapshotEngine
Периодически делает снимки:
- состояния стратегий,
- состояния legs,
- состояния позиций.

Используется для:
- быстрого старта,
- скоростного восстановления state.

---

## 4. Форматы хранения

### 4.1 Key-Value (Redis/LMDB)
Плюсы:
- высокая скорость,
- простота.

Использование:
- runtime state,
- буферы сигналов.

### 4.2 SQL (PostgreSQL/MySQL)
Плюсы:
- консистентность,
- надёжность.

Использование:
- история сделок,
- стратегия → действия → результат,
- конфигурации пользователей.

### 4.3 Append-only логи
Использование:
- EventStore,
- системные события.

---

## 5. Recovery (восстановление после сбоя)

Правильный процесс:

```
1. Загрузить снапшот стратегий
2. Загрузить состояние позиций
3. Загрузить активные ордера
4. Применить события из EventStore (replay)
5. Запустить движки
```

Если биржа сообщает о рассинхронизации:
- принудительное обновление позиций через REST,
- сверка активных ордеров,
- сравнение локального state с биржей.

---

## 6. События, которые сохраняются обязательно

- `order.*`
- `strategy.decision`
- `market.snapshot` (если включена опция записи)
- `signal.snapshot` (для последующего обучения)
- `system.error`
- `system.warning`

---

## 7. Масштабирование Storage Layer

### Горизонтальное:
- Redis-cluster,
- PostgreSQL sharding,
- распределённые file logs через S3/MinIO.

### Вертикальное:
- отдельные таблицы на символ,
- отдельное хранилище для тяжёлых сигналов,
- исторические данные в S3.

---

## 8. Основные требования к Storage Layer

1. Быстрота — миллисекундный доступ.
2. Надёжность — атомарность записи.
3. Реплицируемость — для безопасности.
4. Возможность реплея событий.
5. Возможность восстановления state.

---

## 9. Роль Storage Layer в BotPlatform

Storage Layer делает платформу:
- восстанавливаемой,
- мульти-пользовательской,
- аналитически полной,
- надёжной,
- промышленной.

Без нормального хранилища стратегия теряет память, а бот перестаёт быть системой.

