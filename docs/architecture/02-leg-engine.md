# Пункт A-1 — Leg Engine (Variant C) Архитектурный Документ

## 1. Назначение Leg Engine
Leg Engine — это атомарный модуль стратегии, отвечающий за торговую логику одной ноги:
- управление входами и выходами,
- управление PnL,
- масштабирование (scale-in / scale-out),
- пузырьковые позиции (bubble),
- обработку сигналов,
- сериализацию состояния.

## 2. Принципы архитектуры
Leg является полностью независимым модулем:
- не зависит от биржи,
- не зависит от системных движков,
- не зависит от сигналов,
- не зависит от UI и мониторинга.

Leg получает только:
- текущую позицию (PositionSnapshot),
- рыночные данные (market_snapshot),
- сигналы (SignalSnapshot).

И возвращает:
- ActionIntents — намерения стратегии.

## 3. Структура Leg Engine

```
Leg
├── State
│   ├── PnLState
│   ├── ScaleInState
│   ├── ScaleOutState
│   ├── BubbleState[]
│   └── RuntimeFlags
│
├── Logic
│   ├── process_pnl()
│   ├── process_bubbles()
│   ├── process_scale_in()
│   ├── process_scale_out()
│   └── on_flow_signal()
│
└── Interface
    ├── tick()
    ├── reset()
    ├── serialize()
    ├── deserialize()
    └── produce ActionIntent
```

## 4. Потоки данных
Leg участвует только в следующем цикле:

```
snapshot + market_data + signals → leg.tick() → ActionIntents → Execution Engine → Exchange
```

Leg никогда:
- не отправляет ордера,
- не запрашивает биржу,
- не пишет логи напрямую.

Все действия идут через Strategy Engine.

## 5. Состояние ноги

### 5.1 PnLState
- текущий PnL,
- максимум,
- минимум,
- активные триггеры scale-out.

### 5.2 BubbleState
- отдельные мини-позиции внутри ноги,
- каждая имеет собственный PnL,
- после закрытия добавляет прибыль в общий PnL ноги.

### 5.3 ScaleInState
- шаги усреднения,
- условия активации,
- уровни исполнения.

### 5.4 ScaleOutState
- уровни фиксации прибыли,
- trailing механика.

## 6. Интерфейс Leg
Основной метод:

```
actions = leg.tick(snapshot, price, signals)
```

Leg должен:
- обновить своё состояние,
- принять решения,
- собрать ActionIntents.

Метод reset() вызывается движком при:
- полном закрытии позиции,
- перезапуске стратегии,
- восстановлении состояния.

## 7. Расширяемость
Leg Engine должен обеспечивать:
- добавление новых поведений,
- расширение PnL моделей,
- вставку новых мини-алгоритмов.

## 8. Сериализация
Leg должен иметь:

```
serialize() -> dict
deserialize(dict)
```

Это обеспечивает сохранение состояния между запусками.

## 9. Взаимодействие со Strategy Engine

```
StrategyEngine → Leg.tick() → ActionIntent → ExecutionEngine
ExecutionEngine → OrderEvents → StrategyEngine → Leg
```

Leg не знает, что происходит дальше.

## 10. Назначение Leg Engine в платформе
Leg — базовая часть платформы, позволяющая:

- строить стратегии любой сложности,
- комбинировать ноги,
- создавать многоногие стратегии,
- создавать иерархии ног,
- обеспечивать независимость логики.

Leg — основной строительный блок стратегии.
