
# 16-monitoring-and-alerts.md — Monitoring & Alerts в BotPlatform

## 1. Назначение Monitoring & Alerts

Monitoring & Alerts — это сенсорная система BotPlatform.  
Она отвечает за:

- сбор метрик,
- контроль состояния движков,
- мониторинг задержек и частоты событий,
- предупреждения об ошибках и авариях,
- визуализацию работы платформы,
- сигналы внешним системам (Telegram/Slack/Email).

Это позволяет:
- видеть, что происходит внутри платформы,
- понимать производительность,
- реагировать на сбои до того, как они станут критичными,
- обеспечивать 24/7 устойчивость.

---

## 2. Архитектура Monitoring System

```
MonitoringSystem
├── MetricsCollector
├── EventMonitor
├── HeartbeatMonitor
├── AnomalyDetector
├── AlertRouter
└── AlertSink(s)
     ├── Telegram
     ├── Slack
     ├── Email
     ├── Webhook
     └── PagerDuty
```

---

## 3. Основные цели мониторинга

### 3.1 Технические метрики
- загрузка CPU, RAM,
- задержка обработки тиков,
- частота событий `market.snapshot`,
- время реакции стратегий,
- ошибки движков.

### 3.2 Торговые метрики
- количество ордеров,
- количество сделок,
- средняя задержка исполнения,
- процент успеха стратегий,
- средний PnL по символам.

### 3.3 Системные метрики
- количество ошибок,
- количество перезапусков движков,
- задержка EventBus,
- размер очередей в движках.

---

## 4. Источники данных

Monitoring получает данные из:

- EventBus (`order.*`, `system.error`, `strategy.decision`),
- движков (через internal hooks/logs),
- Storage Layer,
- Config System,
- встроенных heartbeat-датчиков.

---

## 5. Heartbeat Monitor

Каждый движок отправляет heartbeat:

```
system.heartbeat (source="market.engine", latency_ms=21)
```

Monitoring проверяет:
- частоту,
- задержку,
- отклонения.

Если heartbeat пропал — алерт.

---

## 6. MetricsCollector

Собирает метрики:

- время обработки тиков,
- задержки сигналов,
- скорость работы ExecutionEngine,
- состояние сети,
- API-response time.

Метрики сохраняются в Prometheus-формате:

```
metric_name{label="value"} number
```

---

## 7. EventMonitor

Слушает EventBus события:

```
market.snapshot
signal.snapshot
strategy.decision
order.*
system.*
```

Подсчитывает:
- частоту,
- задержки,
- корректность,
- структуру.

---

## 8. AnomalyDetector

ML/heuristics для:

- всплесков ошибок,
- аномального роста задержки,
- отсутствия событий,
- подозрительно частых ордеров,
- подозрительной активности стратегий.

---

## 9. AlertRouter

Маршрутизирует алерты:

```
low severity  → logs
medium        → Telegram
high          → Slack / PagerDuty
critical      → emergency channel
```

---

## 10. AlertSink (механизмы отправки)

### 10.1 Telegram
- быстрые алерты о сбоях стратегий,
- уведомления о крупных PnL,
- ошибки биржевых адаптеров.

### 10.2 Slack
- алерты команды,
- технические уведомления,
- статусы релизов.

### 10.3 Email
- регулярные отчёты,
- уведомления пользователям.

### 10.4 PagerDuty / OpsGenie
- критические инциденты,
- отказ биржи,
- падение движков.

### 10.5 Webhook
- интеграции с внешними системами.

---

## 11. Визуализация метрик

Поддерживаемые системы:

- Grafana (через Prometheus)
- Kibana (через ELK)
- Loki dashboard
- CloudWatch dashboard
- Prometheus UI

Примеры панелей Grafana:

- задержка обработки тиков,
- частота событий,
- скорость ордеров,
- ошибки движков,
- PnL стратегий,
- heartbeat движков.

---

## 12. Реализация Live Monitor (внутренний UI)

Live Monitor предоставляет:
- real-time таблицу действий стратегий,
- состояния позиций,
- движение цен,
- real-time трейды,
- события движения рынка,
- ошибки,
- system health.

---

## 13. Работа Monitoring при сбоях

1. При критической ошибке:
   - отправляет `critical` alert,
   - включает повышенный режим логирования,
   - записывает event-trace.

2. Если движок не отвечает:
   - аннулирует heartbeat,
   - публикует `system.error`,
   - отправляет аварийный alert.

3. При восстановлении:
   - отправляет `system.recovery`.

---

## 14. Хранение метрик

2 типа хранения:

### 14.1 Быстрое временное хранение (Prometheus)
- короткая история,
- высокая детализация.

### 14.2 Долговременное хранение (S3/ClickHouse)
- долгие годы,
- исторический анализ,
- PnL-аналитика.

---

## 15. Минимальный набор мониторинга для продакшена

- heartbeat всех движков,
- задержка event-loop,
- ошибки Execution Engine,
- ошибки биржевых адаптеров,
- количество ордеров в минуту,
- задержка исполнения,
- ошибки стратегий,
- количество system.error по модулям.

---

## 16. Роль Monitoring & Alerts в BotPlatform

Monitoring & Alerts обеспечивает:

- прозрачность работы,
- стабильность 24/7,
- раннее обнаружение проблем,
- стратегическую аналитику,
- защиту капитала,
- способность платформы работать как промышленная торговая система.

Мониторинг — глаза и уши всей платформы.
